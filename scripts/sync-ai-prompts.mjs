#!/usr/bin/env node
/**
 * Sync AI prompts from markdown source files into TypeScript modules.
 *
 * Source of truth:
 * - convex/ai/souls/assistants/<assistantId>/soul.md
 * - convex/ai/onboarding/base.md
 * - convex/ai/onboarding/addendums/<presetId>.md
 *
 * Generated outputs:
 * - convex/ai/souls/client.ts (client-safe soul strings)
 * - convex/ai/onboarding/prompts.ts (onboarding base + addendums)
 */

import fs from "node:fs";
import path from "node:path";

const repoRoot = process.cwd();

const normalizeText = (text) =>
  text.replace(/\r\n/g, "\n").trim();

const readRequired = (relativePath) => {
  const fullPath = path.join(repoRoot, relativePath);
  if (!fs.existsSync(fullPath)) {
    throw new Error(`Missing required file: ${relativePath}`);
  }
  return normalizeText(fs.readFileSync(fullPath, "utf8"));
};

const readOptional = (relativePath) => {
  const fullPath = path.join(repoRoot, relativePath);
  if (!fs.existsSync(fullPath)) return "";
  return normalizeText(fs.readFileSync(fullPath, "utf8"));
};

const writeIfChanged = (relativePath, content) => {
  const fullPath = path.join(repoRoot, relativePath);
  const prev = fs.existsSync(fullPath) ? fs.readFileSync(fullPath, "utf8") : null;
  if (prev === content) return false;
  fs.mkdirSync(path.dirname(fullPath), { recursive: true });
  fs.writeFileSync(fullPath, content, "utf8");
  return true;
};

// -----------------------------
// SOULS -> convex/ai/souls/client.ts
// -----------------------------

const SOUL_SOURCES = [
  {
    id: "gymbro",
    constName: "WORKOUT_COACH_SOUL",
    source: "convex/ai/souls/assistants/gymbro/soul.md",
  },
  {
    id: "custom",
    constName: "CUSTOM_ASSISTANT_SOUL",
    source: "convex/ai/souls/assistants/custom/soul.md",
  },
  {
    id: "martin",
    constName: "MARTIN_ASSISTANT_SOUL",
    source: "convex/ai/souls/assistants/martin/soul.md",
  },
  {
    id: "buddha",
    constName: "BUDDHA_ASSISTANT_SOUL",
    source: "convex/ai/souls/assistants/buddha/soul.md",
  },
  {
    id: "marcus",
    constName: "MARCUS_AURELIUS_SOUL",
    source: "convex/ai/souls/assistants/marcus/soul.md",
  },
  {
    id: "startup",
    constName: "STARTUP_ASSISTANT_SOUL",
    source: "convex/ai/souls/assistants/startup/soul.md",
  },
];

const soulExports = SOUL_SOURCES.map((s) => ({
  ...s,
  text: readRequired(s.source),
}));

const soulsClientTs = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT.
 *
 * Generated by: scripts/sync-ai-prompts.mjs
 * Source of truth: convex/ai/souls/assistants/<assistantId>/soul.md
 */

${soulExports
  .map((s) => `export const ${s.constName} = ${JSON.stringify(s.text)};\n`)
  .join("\n")}
export const DEFAULT_ASSISTANT_SOUL = CUSTOM_ASSISTANT_SOUL;
`;

// -----------------------------
// ONBOARDING -> convex/ai/onboarding/prompts.ts
// -----------------------------

const onboardingBase = readRequired("convex/ai/onboarding/base.md");

const addendumsDir = path.join(repoRoot, "convex/ai/onboarding/addendums");
const addendumFiles = fs.existsSync(addendumsDir)
  ? fs
      .readdirSync(addendumsDir)
      .filter((f) => f.endsWith(".md"))
      .sort()
  : [];

const addendums = {};
for (const file of addendumFiles) {
  const presetId = file.replace(/\.md$/, "");
  addendums[presetId] = readOptional(`convex/ai/onboarding/addendums/${file}`);
}

const onboardingPromptsTs = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT.
 *
 * Generated by: scripts/sync-ai-prompts.mjs
 * Source of truth:
 * - convex/ai/onboarding/base.md
 * - convex/ai/onboarding/addendums/<presetId>.md
 */

export const ONBOARDING_BASE_PROMPT = ${JSON.stringify(onboardingBase)};

export const ONBOARDING_ADDENDUMS: Record<string, string> = ${JSON.stringify(addendums, null, 2)} as const;

export function buildOnboardingPrompt(presetId: string): string {
  const addendum = ONBOARDING_ADDENDUMS[presetId] || "";
  return addendum ? \`\${ONBOARDING_BASE_PROMPT}\\n\\n---\\n\\n\${addendum}\` : ONBOARDING_BASE_PROMPT;
}
`;

const wroteSouls = writeIfChanged("convex/ai/souls/client.ts", soulsClientTs);
const wroteOnboarding = writeIfChanged("convex/ai/onboarding/prompts.ts", onboardingPromptsTs);

if (wroteSouls || wroteOnboarding) {
  console.log(
    `sync-ai-prompts: updated ${[
      wroteSouls ? "convex/ai/souls/client.ts" : null,
      wroteOnboarding ? "convex/ai/onboarding/prompts.ts" : null,
    ]
      .filter(Boolean)
      .join(", ")}`
  );
} else {
  console.log("sync-ai-prompts: no changes");
}
