#!/usr/bin/env node
/**
 * Sync AI prompts from markdown source files into TypeScript modules.
 *
 * Source of truth:
 * - convex/ai/souls/assistants/<assistantId>/soul.md
 *
 * Generated outputs:
 * - convex/ai/souls/client.ts (client-safe soul strings)
 */

import fs from "node:fs";
import path from "node:path";

const repoRoot = process.cwd();

const normalizeText = (text) =>
  text.replace(/\r\n/g, "\n").trim();

const readRequired = (relativePath) => {
  const fullPath = path.join(repoRoot, relativePath);
  if (!fs.existsSync(fullPath)) {
    throw new Error(`Missing required file: ${relativePath}`);
  }
  return normalizeText(fs.readFileSync(fullPath, "utf8"));
};

const writeIfChanged = (relativePath, content) => {
  const fullPath = path.join(repoRoot, relativePath);
  const prev = fs.existsSync(fullPath) ? fs.readFileSync(fullPath, "utf8") : null;
  if (prev === content) return false;
  fs.mkdirSync(path.dirname(fullPath), { recursive: true });
  fs.writeFileSync(fullPath, content, "utf8");
  return true;
};

// -----------------------------
// SOULS -> convex/ai/souls/client.ts
// -----------------------------

const SOUL_SOURCES = [
  {
    id: "gymbro",
    constName: "WORKOUT_COACH_SOUL",
    source: "convex/ai/souls/assistants/gymbro/soul.md",
  },
  {
    id: "custom",
    constName: "CUSTOM_ASSISTANT_SOUL",
    source: "convex/ai/souls/assistants/custom/soul.md",
  },
  {
    id: "buddha",
    constName: "BUDDHA_ASSISTANT_SOUL",
    source: "convex/ai/souls/assistants/buddha/soul.md",
  },
  {
    id: "marcus",
    constName: "MARCUS_AURELIUS_SOUL",
    source: "convex/ai/souls/assistants/marcus/soul.md",
  },
];

const soulExports = SOUL_SOURCES.map((s) => ({
  ...s,
  text: readRequired(s.source),
}));

const soulsClientTs = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT.
 *
 * Generated by: scripts/sync-ai-prompts.mjs
 * Source of truth: convex/ai/souls/assistants/<assistantId>/soul.md
 */

${soulExports
  .map((s) => `export const ${s.constName} = ${JSON.stringify(s.text)};\n`)
  .join("\n")}
export const DEFAULT_ASSISTANT_SOUL = CUSTOM_ASSISTANT_SOUL;
`;

const wroteSouls = writeIfChanged("convex/ai/souls/client.ts", soulsClientTs);

if (wroteSouls) {
  console.log("sync-ai-prompts: updated convex/ai/souls/client.ts");
} else {
  console.log("sync-ai-prompts: no changes");
}
